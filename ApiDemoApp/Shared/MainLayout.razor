@using ApiDemoApp.Pages
@using ApiDemoApp.Models
@using ApiDemoApp.Services
@inject AppState appState
@implements IDisposable
@inherits LayoutComponentBase
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject NavigationManager _navigationManager
@inject AuthenticationStateProvider _authState 

<MudThemeProvider/>
<MudDialogProvider/>
<MudSnackbarProvider/>
<MudLayout>
    <MudAppBar Elevation="1" Color="Color.Transparent">

           <MudPaper Class="d-flex flex-row flex-grow-1 gap-4" Elevation="0">
           <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" Disabled="@notLogin" />
            <MudButton Variant="Variant.Filled" StartIcon="@Icons.Filled.Navigation" IconColor="Color.Inherit" Size="Size.Small" OnClick="@ToggleRightDrawer" Disabled="@notLogin">坐标导航</MudButton>
            <MudButton Variant="Variant.Filled" StartIcon="@Icons.Filled.MoveUp" IconColor="Color.Inherit" Size="Size.Small" OnClick="@ToggleRightDrawer2" Disabled="@notLogin">移动小车</MudButton>
            <MudButton Variant="Variant.Filled" StartIcon="@Icons.Filled.TaskAlt" IconColor="Color.Inherit" Size="Size.Small" Disabled="@notLogin" OnClick="@TaskManager">任务管理</MudButton>
            <MudButton Variant="Variant.Filled" StartIcon="@Icons.Filled.Map" IconColor="Color.Inherit" Size="Size.Small" Disabled="@notLogin" OnClick="@MapManager">地图管理</MudButton>
            <MudButton Variant="Variant.Filled" StartIcon="@Icons.Filled.VerifiedUser" IconColor="Color.Inherit" Size="Size.Small" Disabled="@notLogin" OnClick="@UserManager">用户管理</MudButton>
            <AGVStatus />
            </MudPaper>
         
        @if (notLogin)
        {
            <MudTooltip Text="登录">
                <MudIconButton Icon="@Icons.Filled.Login" Color="Color.Primary" Edge="Edge.End" aria-label="登录" Href="/login" />
            </MudTooltip>
        }
        else
        {
            <MudAvatar Color="Color.Warning" Variant="Variant.Filled">
                <MudTooltip Text="@login_user.EmailAddress">
                    <MudIcon Color="Color.Dark" Icon="@Icons.Filled.Person" Size="Size.Medium" />
                </MudTooltip>
            </MudAvatar>
            <MudTooltip Text="退出登录">
                <MudIconButton Icon="@Icons.Filled.Logout" Color="Color.Primary" Edge="Edge.End" aria-label="退出" Href="/logout" />
            </MudTooltip>
        }



    </MudAppBar>
  
 
    <MudDrawer @bind-Open="_drawerOpen" Elevation="2" Variant="@DrawerVariant.Persistent" Width="380px">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6" Class="mt-1">AGV 列表</MudText>
        </MudDrawerHeader>
        <MudFab Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Add" Size="Size.Small" Href="/addagv"/>
       <AGVList/>
    </MudDrawer>
   
    <MudDrawer @bind-Open="@openRight" Fixed="false" Anchor="Anchor.Right" Elevation="2" Variant="@DrawerVariant.Temporary" Height="850px" Width="@drawerWidth">
           
            @if(targetPoint_Nav){
                 <MudDrawerHeader>
                <MudText Typo="Typo.h6">目标点导航</MudText>
                </MudDrawerHeader>
                 <TargetPoints />
            }
            else{
                  <MudDrawerHeader>
                  <MudText Typo="Typo.h6">移动小车</MudText>
                  </MudDrawerHeader>
                   <MoveAction />
            }
               
        </MudDrawer>

    <MudMainContent>
        <ErrorBoundary>
            <ChildContent>
                    @Body
            </ChildContent>
            <ErrorContent>
                <MudText Typo="Typo.h6">Whoa, sorry about that! While we fix this problem, buy some shirts!</MudText>
            </ErrorContent>
         </ErrorBoundary>
      </MudMainContent>
</MudLayout>
@code {
    [Inject] private IDialogService DialogService { get; set; }
    bool _drawerOpen = false;
    bool openRight = false;
    bool notLogin = true;
    bool targetPoint_Nav = true;
    string drawerWidth;
    RegisterAGVFrom model;
    User login_user;
    protected override void OnInitialized()
    {
        model = appState.SelectedModel;
        appState.OnChange += ReceivedModel;

    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            login_user = await localStorage.GetItemAsync<User>("login_user");
            if (login_user != null)
            {
                var en = Enum.Parse<TestUserType>(login_user.Role);
                var authState = await ((TestAuthenticationStateProvider)_authState).ChangeUser(en);

            }
            var authenticationState = await _authState.GetAuthenticationStateAsync();
            if(authenticationState.User!=null && authenticationState.User.Identity.IsAuthenticated)
            {
                notLogin =false;
                StateHasChanged();
            }
        }

    }

    public void Dispose()
    {
        appState.OnChange -= ReceivedModel;
    }

    void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }



    void CancelNav()
    {
        if (appState.SelectedModel == null) return;
        appState.SetModel(model, ActionType.CANCEL);
        StateHasChanged();


    }

    void NavCharge()
    {
        if (appState.SelectedModel == null) return;
        appState.SetModel(model,ActionType.COMPLETE);
        ToggleRightDrawer();
        StateHasChanged();
    }


    void UserManager()
    {
        // appState.SelectedModel = null;
        _navigationManager.NavigateTo("/usermanager",false);
    }

    void MapManager()
    {
        if (appState.SelectedModel == null) return;
        _navigationManager.NavigateTo("/mapmanager", false);
    }

    void TaskManager()
    {
        if (appState.SelectedModel == null) return;
        _navigationManager.NavigateTo("/taskmanager");
    }

    public void ReceivedModel()
    {
        if (appState.SelectedModel != null)
        {
            model=appState.SelectedModel;
            //if(appState.SelectedType == ActionType.NAVIGATE || appState.SelectedType==ActionType.CANCEL)
            //{
            //    ToggleRightDrawer();
            //    StateHasChanged();
            //}

        }


    }
    void ToggleRightDrawer()
    {
        if (appState.SelectedModel == null) return;
        targetPoint_Nav = true;
        drawerWidth = "450px";
        openRight = !openRight;
    }

    void ToggleRightDrawer2()
    {
        if (appState.SelectedModel == null) return;
        appState.SelectedModel.DrawCoordinates.Clear();
        targetPoint_Nav = false;
        drawerWidth = "300px";
        openRight = !openRight;
    }
    
}

