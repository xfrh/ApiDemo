
@using ApiDemoApp.Models
@using ApiDemoApp.Services
@inject AppState appState
@inject DataService dataService
@inject ImageService imageService
@inject NavigationManager _navigationManager
@implements IDisposable;
@inject Blazored.LocalStorage.ILocalStorageService localStorage
<MudPaper Class="pa-4 mr-16" Elevation="0">

<MudList  Clickable=true  SelectedItem="_selectedItem" SelectedItemChanged="OnSelectedItemChanged" >
        @foreach(var model in lst)
        {
              <MudListItem   Avatar="@Icons.Material.Filled.Image"  Value=@model.url Text=@model.name Tag=@model.type />
        }
  </MudList>
</MudPaper>

@code {
    List<RegisterAGVFrom> lst =new List<RegisterAGVFrom>();
    MudListItem _selectedItem;

    protected override void OnInitialized()
    {
        appState.OnChange += ReceiveData;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            lst = await localStorage.GetItemAsync<List<RegisterAGVFrom>>("agv_table");
            if (lst == null)
                lst = new List<RegisterAGVFrom>();
            StateHasChanged();
        }

    }

    public void Dispose()
    {
        appState.OnChange -= ReceiveData;
    }

    public void ReceiveData()
    {
        if (appState.SelectedModel != null) {
            if (appState.SelectedType == ActionType.ADD)
            {
                lst.Add(appState.SelectedModel);
                appState.SelectedModel = null;
                StateHasChanged();
            }
            else if (appState.SelectedType == ActionType.DELETE)
            {
                var q = lst.FirstOrDefault(v => v.name == appState.SelectedModel.name);
                if (q != null)
                    lst.Remove(q);
                StateHasChanged();
            }

        }


    }

    private async void CreateImage()
    {
        try
        {
            MapLayer mapLayer = await dataService.Cur_Map();
            String filePath = System.IO.Path.Combine(Directory.GetCurrentDirectory(), "wwwroot\\Images\\layout1.png");
            byte[] imageBytes = Convert.FromBase64String(mapLayer.image_url.Replace("data:image/png;base64,","").Trim());
            imageService.CreateImage(imageBytes,mapLayer.width,mapLayer.height);
            List<TargetPointsModel> targetPointsModels = await dataService.Target_Points();
            imageService.SetTargetPoints(targetPointsModels);
        
            _navigationManager.NavigateTo("/map");

        }
        catch (Exception ex)
        {

            LogService.LogMessage("create image:" + ex.Message );
        }
    }


    private void OnSelectedItemChanged(MudListItem item)
    {
        _selectedItem = item;
        RegisterAGVFrom _model =new RegisterAGVFrom();
        _model.name = _selectedItem.Text;
        _model.url = _selectedItem.Value.ToString();
        _model.type = _selectedItem.Tag.ToString();
        dataService.Base_URL = "http://" + _model.url;
        appState.SetModel(_model,ActionType.SELECTED);
        StateHasChanged();
        CreateImage();
    }

}
