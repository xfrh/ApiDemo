@page "/taskmanager"
@attribute [Authorize(Roles="Admin")]
@using System.ComponentModel.DataAnnotations
@using ApiDemoApp.Models
@using ApiDemoApp.Services
@using System
@using System.Text
@using System.Reflection
@using Quartz
@using Quartz.Impl
@using System.Text.Json
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject ApiDemoApp.Services.AppState appState
@inject DataService dataService
@inject ISchedulerFactory _iSchedulerFactory
<MudGrid Class="pa-4 mt-16"  >
    <MudItem xs="12" sm="5"  >
        <EditForm Model="@model" OnValidSubmit="OnValidSubmit">
            <DataAnnotationsValidator />
            <MudCard Outlined="true" >
                <MudCardContent class="d-flex  flex-grow-1 gap-4">
                    <MudItem xs="12" sm="6" md="4">
                        <MudField Label="任务标题" Variant="Variant.Outlined">
                         <MudTextField  Class="mt-3" @bind-Value="model.Title" For="@(() => model.Title)" />

                        </MudField>
                    </MudItem>
                       <MudItem xs="12" sm="6" md="4">
                        <MudField Label="开始时间" Variant="Variant.Outlined" >
                            <MudTimePicker @bind-Time="time" />
                        </MudField>
                    </MudItem>

                  
                  
                  
                     </MudCardContent>
                   </MudCard>
                   <MudCard>
                <MudCardContent class="d-flex  flex-grow-1 gap-4">
                  

                    <MudItem xs="12" sm="6" md="4" >
                        <MudField Label="执行模式" Variant="Variant.Outlined" InnerPadding="false">
                            <MudRadioGroup @bind-SelectedOption="model.CycleStyle">
                                <MudRadio Option="false" Color="Color.Primary" Dense="true" >单次循环</MudRadio>
                                <MudRadio Option="true" Color="Color.Secondary" Dense="false">时长循环</MudRadio>
                            </MudRadioGroup>
                        </MudField>
                    </MudItem>

                     <MudItem xs="12" sm="6" md="4" >
                        <MudField Label="任务完成后" Variant="Variant.Outlined" InnerPadding="false">
                            <MudRadioGroup @bind-SelectedOption="model.AfterTask" >
                                <MudRadio Option="false" Dense="true" >返回开始点</MudRadio>
                                <MudRadio Option="true" Dense="false">去充电</MudRadio>
                            </MudRadioGroup>
                        </MudField>
                    </MudItem>
                </MudCardContent>
            </MudCard>
            <MudCard>
                <MudCardContent class="d-flex  flex-grow-1 gap-4">
                    <MudItem xs="12" sm="6" md="4">
                     
                           <MudSelect T="string" Label="重复" MultiSelection="true" @bind-Value="week_value" @bind-SelectedValues="model.WeekOptions">
                            @foreach (var wkday in wkDays)
                            {
                                <MudSelectItem T="string" Value="@wkday">@wkday</MudSelectItem>
                            }
                        </MudSelect>
                     
                    </MudItem>
                       <MudItem xs="12" sm="6" md="4">
                        <MudSelect Label="目标点" MultiSelection="true" @bind-Value="target_value" @bind-SelectedValues="model.TargetOptions">
                            @foreach (var target in targets)
                            {
                                <MudSelectItem Value="@target">@target</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                   
                </MudCardContent>
                <MudCardActions>
                    <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto">注册</MudButton>
                </MudCardActions>
            </MudCard>
        </EditForm>
    </MudItem>
    <MudItem xs="12" sm="7">
        <MudPaper Class="pa-4 mud-height-full">
            <MudTable Items="@lst" @ref="mudTable" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info" OnRowClick="RowClick" T="AGVTaskModel">
                <HeaderContent>
                    <MudTh>机器人编号</MudTh>
                    <MudTh>任务标题</MudTh>
                    <MudTh>执行模式</MudTh>
                    <MudTh>开始时间</MudTh>
                   <MudTh>任务完成后</MudTh> 
                   <MudTh>目标点</MudTh> 
                    <MudTh>重复</MudTh> 
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="机器人编号">@context.AGV_No</MudTd>
                    <MudTd DataLabel="任务标题">@context.Title</MudTd>
                    <MudTd DataLabel="执行模式">@(context.CycleStyle==false?"单次循环":"时长循环")</MudTd>
                    <MudTd DataLabel="开始时间">@context.StartTime</MudTd>
                    <MudTd DataLabel="任务完成后">@(context.AfterTask==true?"去充电":"返回开始点")</MudTd>
                    <MudTd DataLabel="目标点">@context.TargetName</MudTd>
                    <MudTd DataLabel="重复">@(string.Join(",", context.WeekOptions.ToArray()))</MudTd>

                </RowTemplate>
            </MudTable>
        </MudPaper>
    </MudItem>

</MudGrid>



    @code {

    [Inject] private IDialogService DialogService { get; set; }
    IScheduler scheduler;
    TriggerKey triggerKey;
    AGVTaskModel model = new AGVTaskModel();
    List<AGVTaskModel> lst = new List<AGVTaskModel>();
    List<string> targets = new List<string>();
    private bool _loading;
    AGVTaskModel _selectedItem;
    bool success;
    private MudTable<AGVTaskModel> mudTable;
    TimeSpan? time = new TimeSpan(00, 00, 00);
    string schedulModel = "0 0 12 ? *";
    private string week_value { get; set; } = "Nothing selected";
    private string target_value { get; set; } = "Nothing selected";
    private Coordinace start_point;
    private string[] wkDays =
    {
        "周一", "周二", "周三", "周四",
        "周五", "周六", "周日", 
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            targets.Clear();
            start_point = await dataService.Cur_Position();
            lst = await localStorage.GetItemAsync<List<AGVTaskModel>>("agv_task");
            List<TargetPointsModel> pp = await dataService.Target_Points();
            foreach (var p in pp)
                targets.Add(p.name);
            if (lst == null)
                lst = new List<AGVTaskModel>();
            foreach (var model in lst)
                EditShowList(model);
            StateHasChanged();
        }

    }

    private async void OnValidSubmit(EditContext context)
    {
        if(string.IsNullOrEmpty(model.Title)) return;
        var q = lst.FirstOrDefault(v=>v.Title== model.Title);
        if(q!=null) return;
        if(model.WeekOptions.Count()==0) return;
        if (model.TargetOptions.Count() == 0) return;

        string temp = "";
        model.AGV_No = appState.SelectedModel.name;
        model.StartTime = time;
        model.TargetName="";
       
        foreach(var item in model.TargetOptions){
            temp += item + ",";
        }
        model.TargetName = temp.TrimEnd(',');
        EditShowList(model);
        lst.Add(model);
        await localStorage.SetItemAsync<List<AGVTaskModel>>("agv_task", lst);

        appState.SetModel(appState.SelectedModel, ActionType.ADDTASK);
        await AddToSchedule();
        await this.InvokeAsync(() => this.StateHasChanged());
        model = new AGVTaskModel();

    }

    private async Task AddToSchedule()
    {
        try
        {
            scheduler = await _iSchedulerFactory.GetScheduler();
            IJobDetail job = JobBuilder.Create<ScheduleJobService>()
           .WithIdentity(model.Title, model.AGV_No)
           .UsingJobData("url",appState.SelectedModel.url)
           .UsingJobData("target",model.TargetName)
           .UsingJobData("after", model.AfterTask ? null : JsonSerializer.Serialize(start_point))
            .Build();
          
            triggerKey = new TriggerKey(model.Title);
            // Trigger the job to run now, and then repeat every 10 seconds
            ITrigger trigger = TriggerBuilder.Create()
                .WithIdentity(triggerKey)
                .StartNow()
                 //.WithSimpleSchedule(x => x
                 //        .WithIntervalInSeconds(10)
                 //        .RepeatForever())
                 .WithCronSchedule(schedulModel) //every Wednesday at 12:00 pm "0 0 12 ? * WED"

                .Build();
            await scheduler.Start();
            // Tell quartz to schedule the job using our trigger
            await scheduler.ScheduleJob(job, trigger);
        }
        catch (Exception ex)
        {

            LogService.LogMessage(ex.Message);
        }

   
    }

    private async void RowClick(TableRowClickEventArgs<AGVTaskModel> tableRowClickEventArgs)
    {
        try
        {
            AGVTaskModel aGVTaskModel = tableRowClickEventArgs.Item;
            bool? result = await DialogService.ShowMessageBox(
               "警告",
               "确实要删除该任务吗!",
               yesText: "Delete!", cancelText: "Cancel");
            if (result != null)
            {
                var q = lst.FirstOrDefault(v => v.Title == aGVTaskModel.Title && v.AGV_No == aGVTaskModel.AGV_No);
                if (q != null)
                {
                    lst.Remove(q);
                    if (lst.Count == 0)
                        await localStorage.RemoveItemAsync("agv_task");
                    else
                        await localStorage.SetItemAsync<List<AGVTaskModel>>("agv_task", lst);
                    appState.SetModel(appState.SelectedModel, ActionType.ADDTASK);
                    if (triggerKey == null) 
                    triggerKey = new TriggerKey(q.Title);
                    if(scheduler==null)
                       scheduler = await _iSchedulerFactory.GetScheduler();
                    await scheduler.UnscheduleJob(triggerKey);
                    appState.SetModel(appState.SelectedModel, ActionType.CANCEL);
                    StateHasChanged();
                }

            }

        }
        catch (Exception ex)
        {
            
            LogService.LogMessage(ex.Message);
        }
      
    }


    private void EditShowList(AGVTaskModel _model){
   
        schedulModel = "0 " + _model.StartTime.Value.Minutes  + " " + _model.StartTime.Value.Hours  +   " ? * ";
        foreach(var p in _model.WeekOptions){
             switch(p){
                case "周一":
                    schedulModel += "MON,";
                    break;
                case "周二":
                    schedulModel +="TUE,";
                    break;
                case "周三":
                    schedulModel += "WED,";
                    break;
                case "周四":
                    schedulModel += "THU,";
                    break;
                case "周五":
                    schedulModel += "FRI,";
                    break;
                case "周六":
                    schedulModel += "SAT,";
                    break;
                case "周日":
                    schedulModel += "SUN,";
                    break;

            }
        }

          schedulModel = schedulModel.TrimEnd(',');

    }
 
}